version: "3.9"

# ------------------------------------------------------------------------------
# Services
# ------------------------------------------------------------------------------

# Grafana
# sudo systemctl status grafana-agent.service

services:

  # --- Bitcoin daemon
  bitcoind:
    build:
      context: ./bitcoind
      args:
        BITCOIN_VERSION: 22.0  # Update to install new versions of bitcoin core
    ports:
      - 8333:8333
      # - 127.0.0.1:8332:8332  # exposes RPC to localhost
    expose:
      - 8332  # Only expose RPC to other services
    volumes:
      - bitcoind-data:/root/.bitcoin
    restart: always  # docker will restart on system boot

  # --- Backend
  backend:
    build: ./backend
    # command: ./manage.py runserver 0.0.0.0:8000
    command: ./manage.py trans
    volumes:
      - ./backend:/code
      - bitcoind-data:/root/.bitcoin
    ports:
      - 8000:8000
    depends_on:
      - bitcoind
    extra_hosts:
      - host.docker.internal:172.17.0.1
    restart: always

# ------------------------------------------------------------------------------
# Volumes
# ------------------------------------------------------------------------------

volumes:
  # Bitcoin core volume. It's large, so I mount an external 1TB drive
  bitcoind-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /media/btcdisk