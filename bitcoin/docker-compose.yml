version: "3.9"

# Grafana
# sudo systemctl status grafana-agent.service


# ------------------------------------------------------------------------------
# Services
# ------------------------------------------------------------------------------

services:
  # --- Bitcoin daemon
  bitcoind:
    build:
      context: ./bitcoind
      args:
        VERSION: ${BTD_VERSION}
    ports:
      - 8333:8333  # Incoming connections port
    expose:
      - 1009  # RPC
      - 28332 # ZMQ txs
      - 28333 # ZMQ blocks
    volumes:
      - bitcoind-data:/root/.bitcoin
    restart: always
    command: [
      "bitcoind",
      "-rpcuser=${BTD_RPC_USER}",
      "-rpcpassword=${BTD_RPC_PASSWORD}",
      "-conf=/root/bitcoin.conf"
    ]

  # --- Lightning
  # https://github.com/lightningnetwork/lnd
  lnd:
    # Builds lnd from source using the Dockerfile they include
    build:
      context: ./lightning
      args:
        checkout: master
    command: [
      "lnd",
      "--configfile=/root/lnd.conf",
      "--bitcoind.rpcuser=${BTD_RPC_USER}",
      "--bitcoind.rpcpass=${BTD_RPC_PASSWORD}"
    ]
    ports:
      - 10009:1009  # RPC
      - 8080:8080  # REST
    volumes:
      - lnd-data:/root/.lnd
      # Lightning shares a few resources with rtl
      - lnd-shared:/root/shared
    depends_on:
      - bitcoind

  # --- lightning dashboard
  # list of other dashboards: https://gist.github.com/bretton/163ff7b5186cfc082342d90cc671461b
  rtl:
    build: 
      context: rtl
      dockerfile: dockerfiles/Dockerfile
    depends_on:
      - lnd
    volumes:
      - lnd-data:/root/.lnd  # NOOOOOOO!!!
      - lnd-shared:/shared
      - rtl-data:/data
    ports:
      - 3000:3000
    environment:
      PORT: 3000
      HOST: 0.0.0.0
      MACAROON_PATH: /shared
      LN_SERVER_URL: https://lnd:8080
      CONFIG_PATH: ''
      LN_IMPLEMENTATION: LND
      SWAP_SERVER_URL: https://lnd:8081
      SWAP_MACAROON_PATH: /shared
      RTL_SSO: 0
      RTL_COOKIE_PATH: ''
      LOGOUT_REDIRECT_LINK: ''
      RTL_CONFIG_PATH: /RTL
      BITCOIND_CONFIG_PATH: ''
      CHANNEL_BACKUP_PATH: /data/rtl_backups
      THEME_MODE: NIGHT
    
  # --- Backend
  # backend:
  #   build: ./backend
  #   # command: ./manage.py runserver 0.0.0.0:8000
  #   command: ./manage.py trans
  #   volumes:
  #     - ./backend:/code
  #   environment:
  #     - BTD_RPC_USER
  #     - BTD_RPC_PASSWORD
  #   ports:
  #     - 8000:8000
  #   depends_on:
  #     - bitcoind
  #   extra_hosts:
  #     - host.docker.internal:172.17.0.1
  #   restart: always

# ------------------------------------------------------------------------------
# Volumes
# ------------------------------------------------------------------------------

volumes:
  # Bitcoin core volume. It's large, so I mount an external 1TB drive
  bitcoind-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /media/btcdisk
  lnd-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /media/btcbigdisk/lnd
  lnd-shared:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /media/btcbigdisk/lnd-shared
  rtl-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /media/btcbigdisk/rtl